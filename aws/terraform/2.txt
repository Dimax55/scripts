#-----------------------------
#My Terraform config
#Build WebServer 
#-----------------------------

provider "aws" {
	region = "eu-central-1"
}

resource "aws_instance" "my_webserver" {
	ami = "ami-hioihvwhiov" 	#Amazon Linux AMI
	instance_type = "t3.micro"
	vpc_security_group_ids = [aws_security_group.my_webserver.id] 	#додати групову політику до сервера(або декілька)
	#створили залежність, спочатку створиться група а потім інстанс
	
	user_data = <<EOF 		#записуємо вложенні команд(shell script) для запуску apache2 на сервері
#!/bin/bash
yum -y update
yum -y install httpd
myip='curl http://169.254.169.254/latest/meta-data/local-ipv4'
echo "<h2>WebServer with IP: $myip</h2><br>Build by Terraform!" > /var/www/html/index.html
sudo service httpd start
chkconfig httpd on
EOF

}

#
resource "aws_security_group" "my_webserver" {
  name        = "WebServer Security Group"
  description = "my first securityGroup"

	ingress {	#те що приходить на сервер
	 from_port = 80
	 to_port = 80
	 protocol = "tcp"
	 cidr_blocks = ["0.0.0.0/0"]
	}
	
	ingress {	#те що приходить на сервер
	 from_port = 443
	 to_port = 443
	 protocol = "tcp"
	 cidr_blocks = ["0.0.0.0/0"]
	}

	egres {		#те що йде від сервера
	 from_port = 0
	 to_port = 0
	 protocol = "-1"
	 cidr_blocks = ["0.0.0.0/0"]
	}

}
#terraform init
#terraform plan
#terraform apply  (yes)
#Apply complete! Resources: 2 added,0 changed,0 destroyed.


#добавляємо тег в resorce "aws_instance" 
tags = {
Name = "Web server build by terraform"
Owner = "test user1"
}
#terraform plan
#terraform apply  (yes)
 #Apply complete! Resources: 0 added,1 changed,0 destroyed.


#terraform destroy




#shell скрипт виносино в окремий файл

touch user_data.sh
	#!/bin/bash
	yum -y update
	yum -y install httpd
	myip='curl http://169.254.169.254/latest/meta-data/local-ipv4'
	echo "<h2>WebServer with IP: $myip</h2><br>Build by Terraform!" > /var/www/html/index.html
	sudo service httpd start
	chkconfig httpd on

# в полі user_data = file("./user_data.sh")
terraform plan
terraform apply

!!!! якщо знінювати user_data.sh інстанс буде видаляться і ствроюватися інший
(зупинеться, видалиться та створиться інший)















